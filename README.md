# VFL å‚ç›´è¯é‚¦å­¸ç¿’é›»åŠ›éœ€æ±‚é æ¸¬ç³»çµ±

## é …ç›®æ¦‚è¿°

åŸºæ–¼ **å‚ç›´è¯é‚¦å­¸ç¿’ï¼ˆVertical Federated Learning, VFLï¼‰** çš„é›»åŠ›éœ€æ±‚é æ¸¬ç ”ç©¶é …ç›®ï¼Œä½¿ç”¨ **Transformer æ¨¡å‹** å’Œ **FedAvg è¯é‚¦å¹³å‡ç®—æ³•**å¯¦ç¾é›™æ–¹æ•¸æ“šèåˆé æ¸¬ï¼ŒåŒæ™‚ä¿è­·æ•¸æ“šéš±ç§ã€‚

## VFL æ¶æ§‹èªªæ˜

###  ç³»çµ±æ¶æ§‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    VFL ç³»çµ±æ¶æ§‹                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚   Server    â”‚          â”‚  Clients (x5)        â”‚      â”‚
â”‚  â”‚   (é›²ç«¯)     â”‚          â”‚  (æœ¬åœ° Consumer)      â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚                                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ Weather Model (é›²ç«¯ï¼Œå¯è¨“ç·´)                       â”‚  â”‚
â”‚  â”‚ - è¼¸å…¥: Weather ç‰¹å¾µ (9ç¶­)                        â”‚  â”‚
â”‚  â”‚ - è¼¸å‡º: Weather åµŒå…¥ (256ç¶­)                      â”‚  â”‚
â”‚  â”‚ - è¨“ç·´: FedAvg èšåˆå¤šå®¢æˆ¶ç«¯æ¢¯åº¦                  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                        â†“ åµŒå…¥å‚³è¼¸                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ HFL Model (æœ¬åœ°ï¼Œå‡çµ)                            â”‚  â”‚
â”‚  â”‚ - è¼¸å…¥: Consumer é›»å™¨ç”¨é›» (14ç¶­)                  â”‚  â”‚
â”‚  â”‚ - è¼¸å‡º: HFL åµŒå…¥ (256ç¶­)                          â”‚  â”‚
â”‚  â”‚ - æ¬Šé‡: Per-FedAvg å€‹æ€§åŒ–æ¨¡å‹ (å¯é¸)             â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                        â†“                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ Fusion Model (æœ¬åœ°ï¼Œå¯è¨“ç·´)                       â”‚  â”‚
â”‚  â”‚ - è¼¸å…¥: Weather åµŒå…¥ + HFL åµŒå…¥                   â”‚  â”‚
â”‚  â”‚ - è¼¸å‡º: Power_Demand é æ¸¬                         â”‚  â”‚
â”‚  â”‚ - è¨“ç·´: æœ¬åœ°å„ªåŒ–                                  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                        â†‘ æ¢¯åº¦å›å‚³                        â”‚
â”‚                    (åƒ… Weather Model)                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

###  éš±ç§ä¿è­·æ©Ÿåˆ¶

1. **æ•¸æ“šä¸å‡ºåŸŸ**
   - Weather æ•¸æ“šï¼šåªåœ¨é›²ç«¯è™•ç†
   - HFL æ•¸æ“šï¼šåªåœ¨æœ¬åœ°è™•ç†
   - Power_Demand æ¨™ç±¤ï¼šåªå­˜åœ¨æ–¼æœ¬åœ°

2. **åµŒå…¥å‚³è¼¸**
   - é›²ç«¯ â†’ æœ¬åœ°ï¼šå‚³è¼¸ Weather åµŒå…¥å‘é‡ (256ç¶­)
   - æœ¬åœ°ä¸å‚³è¼¸åŸå§‹æ•¸æ“šï¼Œä¿è­·ç”¨æˆ¶éš±ç§

3. **æ¢¯åº¦èšåˆ**
   - æœ¬åœ° â†’ é›²ç«¯ï¼šå‚³è¼¸ Weather Model çš„æ¢¯åº¦
   - ä¸æš´éœ²åŸå§‹ç‰¹å¾µå’Œæ¨™ç±¤

###  è¨“ç·´ç­–ç•¥

**åˆ†éšæ®µè¨“ç·´ (ç¯€çœé€šè¨Š)**:
- éšæ®µ1 (å‰ 10 è¼ª): æ¯è¼ªéƒ½è¨“ç·´ Fusion + Weather
- éšæ®µ2 (å¾Œ 90 è¼ª): 4 è¼ªè¨“ç·´ Fusionï¼Œ1 è¼ªè¨“ç·´ Weather

**é€šè¨Šç¯€çœ**: ç´„ 82% (100è¼ªä¸­åªæœ‰18è¼ªæ›´æ–° Weather Model)

## å¿«é€Ÿé–‹å§‹

### å‰ç½®éœ€æ±‚

- Python 3.8+
- PyTorch 2.0+
- æ•¸æ“šæ–‡ä»¶:
  - `data/Weather.csv` (Weather æ•¸æ“š)
  - `data/processed/Consumer_*.csv` (å®¢æˆ¶ç«¯æ•¸æ“š)

### å®‰è£æ­¥é©Ÿ

1. **å…‹éš†æˆ–é€²å…¥é …ç›®ç›®éŒ„**
```bash
cd VFL
```

2. **å®‰è£ä¾è³´**
```bash
pip install -r requirements.txt
```

3. **æª¢æŸ¥é…ç½®**
```bash
python config.py
```

### é–‹å§‹è¨“ç·´

#### æ–¹æ³•ä¸€ï¼šå¾Œå°è¨“ç·´ï¼ˆæ¨è–¦ï¼‰
```bash
# é–‹å§‹è¨“ç·´
./run.sh

# ç›£æ§è¨“ç·´éç¨‹
tail -f logs/train_*.log

# åœæ­¢è¨“ç·´
./stop.sh
```

#### æ–¹æ³•äºŒï¼šç›´æ¥é‹è¡Œ
```bash
# è¨“ç·´æ¨¡å‹ï¼ˆé»˜èªä½¿ç”¨ config.yamlï¼‰
python train.py

# è¨“ç·´æ¨¡å‹ï¼ˆæŒ‡å®šé…ç½®æ–‡ä»¶ï¼‰
python train.py --config custom_config.yaml
```

## é …ç›®æ¶æ§‹

### æ ¸å¿ƒçµ„ä»¶

```
VFL/
â”œâ”€â”€ Server.py          # VFL æœå‹™å™¨ (Weather Model å”èª¿å™¨)
â”œâ”€â”€ Client.py          # VFL å®¢æˆ¶ç«¯ (HFL + Fusion Model)
â”œâ”€â”€ Model.py           # Transformer æ¨¡å‹ + Fusion æ¨¡å‹
â”œâ”€â”€ DataLoader.py      # æ™‚åºæ•¸æ“šåŠ è¼‰å™¨
â”œâ”€â”€ Trainer.py         # è¨“ç·´å™¨ (æ•¸æ“šåˆ†å‰²ã€è©•ä¼°)
â”œâ”€â”€ Personalizer.py    # Per-FedAvg å€‹æ€§åŒ–æ¨¡å‹åˆå§‹åŒ–å™¨
â”œâ”€â”€ config.py          # é…ç½®è¼‰å…¥å™¨
â”œâ”€â”€ train.py           # è¨“ç·´ä¸»è…³æœ¬
â””â”€â”€ test.py            # æ¸¬è©¦èˆ‡å¯è¦–åŒ–è…³æœ¬
```

### æ•¸æ“šçµ„ç¹”

```
data/
â”œâ”€â”€ Weather.csv                    # Weather æ•¸æ“š (é›²ç«¯)
â”œâ”€â”€ processed/
â”‚   â”œâ”€â”€ Consumer_01.csv            # å®¢æˆ¶ç«¯ 1
â”‚   â”œâ”€â”€ Consumer_02.csv            # å®¢æˆ¶ç«¯ 2
â”‚   â”œâ”€â”€ ...
â”‚   â””â”€â”€ Consumer_05.csv            # å®¢æˆ¶ç«¯ 5
â””â”€â”€ scalers/                       # æ¨™æº–åŒ–å™¨ (è‡ªå‹•ç”Ÿæˆ)
    â”œâ”€â”€ weather_scaler.pkl
    â”œâ”€â”€ hfl_scaler.pkl
    â””â”€â”€ target_scaler.pkl
```

### è¼¸å‡ºç›®éŒ„

```
ğŸ“ checkpoints/         # æ¨¡å‹æª¢æŸ¥é»
   â”œâ”€â”€ best_weather_model.pth
   â”œâ”€â”€ final_weather_model.pth
   â””â”€â”€ Consumer_*_fusion_model.pth
ğŸ“ plots/              # å¯è¦–åŒ–åœ–è¡¨
ğŸ“ logs/               # è¨“ç·´æ—¥èªŒ
```

## é…ç½®èªªæ˜

### æ ¸å¿ƒé…ç½®æ–‡ä»¶ï¼š`config.yaml`

#### è¯é‚¦å­¸ç¿’é…ç½®
```yaml
federated_learning:
  algorithm: "vfl_fedavg"    # VFL è¯é‚¦å¹³å‡ç®—æ³•
  global_rounds: 100         # å…¨å±€è¨“ç·´è¼ªæ•¸
  num_clients: 5             # å®¢æˆ¶ç«¯æ•¸é‡

  training_strategy:
    phase1_rounds: 10        # éšæ®µ1è¼ªæ•¸
    phase2_rounds: 90        # éšæ®µ2è¼ªæ•¸
    phase2_fusion_freq: 4    # éšæ®µ2ä¸­ Fusion è¨“ç·´é »ç‡
```

#### æ¨¡å‹é…ç½®
```yaml
# Weather Model (é›²ç«¯)
weather_model:
  feature_dim: 9             # Weather ç‰¹å¾µç¶­åº¦
  d_model: 256               # Transformer æ¨¡å‹ç¶­åº¦
  output_dim: null           # VFLä¸éœ€è¦è¼¸å‡ºå±¤

# HFL Model (æœ¬åœ°)
hfl_model:
  feature_dim: 14            # HFL ç‰¹å¾µç¶­åº¦
  freeze: true               # å‡çµHFLæ¨¡å‹

# Fusion Model (æœ¬åœ°)
fusion_model:
  hidden_dim: 256            # èåˆå±¤éš±è—ç¶­åº¦
  output_dim: 1              # Power_Demandé æ¸¬
```

#### æ•¸æ“šé…ç½®
```yaml
data:
  weather_features: [9å€‹Weatherç‰¹å¾µ]
  hfl_features: [14å€‹Consumeré›»å™¨ç‰¹å¾µ]
  target: ["Power_Demand"]
  train_ratio: 0.8           # è¨“ç·´é›†æ¯”ä¾‹
```

## ä½¿ç”¨æŒ‡å—

### è¨“ç·´å‘½ä»¤

| å‘½ä»¤ | åŠŸèƒ½ |
|------|------|
| `./run.sh` | å¾Œå°è¨“ç·´ (æ¨è–¦) |
| `./stop.sh` | åœæ­¢è¨“ç·´ |
| `python train.py` | å‰å°è¨“ç·´ |
| `python train.py --config xxx.yaml` | ä½¿ç”¨è‡ªå®šç¾©é…ç½® |

### ç›£æ§å’Œæ—¥èªŒ

```bash
# å¯¦æ™‚æŸ¥çœ‹è¨“ç·´æ—¥èªŒ
tail -f logs/train_*.log

# æª¢æŸ¥è¨“ç·´ç‹€æ…‹
ps aux | grep python
```

## Per-FedAvg æ•´åˆ

### ä½¿ç”¨å€‹æ€§åŒ– HFL æ¨¡å‹

1. **å…ˆé‹è¡Œ PerFedAvgHVP è¨“ç·´**
```bash
cd ../PerFedAvgHVP
python train.py
```

2. **é…ç½® VFL ä½¿ç”¨å€‹æ€§åŒ–æ¨¡å‹**
```yaml
personalization:
  use_personalized_hfl: true
  hfl_model_path: "../PerFedAvgHVP/checkpoints/final_global_model.pth"
```

3. **é‹è¡Œ VFL è¨“ç·´**
```bash
python train.py
```

## æŠ€è¡“ç´°ç¯€

### VFL è¨“ç·´æµç¨‹

1. **åˆå§‹åŒ–éšæ®µ**
   - Server å‰µå»ºå…¨å±€ Weather Model
   - Clients å‰µå»º HFL Model (å‡çµ) + Fusion Model (å¯è¨“ç·´)

2. **è¯é‚¦å­¸ç¿’å¾ªç’°** (æ¯è¼ª)
   - Server åˆ†ç™¼ Weather Model åˆ°å„å®¢æˆ¶ç«¯
   - Clients æœ¬åœ°è¨“ç·´:
     * Weather åµŒå…¥ + HFL åµŒå…¥ â†’ Fusion é æ¸¬
     * æ›´æ–° Fusion Model (ç¸½æ˜¯)
     * æ›´æ–° Weather Model (æ ¹æ“šç­–ç•¥)
   - Clients å›å‚³ Weather Model æ¢¯åº¦
   - Server èšåˆæ¢¯åº¦ä¸¦æ›´æ–°å…¨å±€æ¨¡å‹

3. **è©•ä¼°èˆ‡ä¿å­˜**
   - æ—©åœæ©Ÿåˆ¶ç›£æ§é©—è­‰æå¤±
   - ä¿å­˜æœ€ä½³å’Œæœ€çµ‚æ¨¡å‹

### FedAvg èšåˆç­–ç•¥

```python
# åŠ æ¬Šå¹³å‡æ¢¯åº¦
for param_idx in range(num_params):
    weighted_grad = sum(
        grad[param_idx] * (weight / total_weight)
        for grad, weight in zip(client_grads, client_weights)
    )
```

## æ•…éšœæ’é™¤

### å¸¸è¦‹å•é¡Œ

1. **æ•¸æ“šæ–‡ä»¶æ‰¾ä¸åˆ°**
```bash
# æª¢æŸ¥æ•¸æ“šç›®éŒ„çµæ§‹
ls -R data/
```

2. **å…§å­˜ä¸è¶³**
```yaml
# ä¿®æ”¹ config.yaml
local_training:
  batch_size: 16  # å¾ 32 æ¸›å°‘åˆ° 16
```

3. **è¨­å‚™éŒ¯èª¤**
```yaml
# å¼·åˆ¶ä½¿ç”¨ CPU
device:
  type: "cpu"
```

## é …ç›®ä¾è³´

| å¥—ä»¶ | ç‰ˆæœ¬è¦æ±‚ | åŠŸèƒ½ |
|------|----------|------|
| **torch** | â‰¥2.0.0 | PyTorchæ·±åº¦å­¸ç¿’æ¡†æ¶ |
| **numpy** | â‰¥1.21.0 | é«˜æ€§èƒ½æ•¸å€¼è¨ˆç®— |
| **pandas** | â‰¥1.3.0 | æ•¸æ“šè™•ç†å’Œåˆ†æ |
| **scikit-learn** | â‰¥1.0.0 | æ©Ÿå™¨å­¸ç¿’å·¥å…· |
| **matplotlib** | â‰¥3.5.0 | å¯è¦–åŒ– |
| **pyyaml** | â‰¥6.0 | é…ç½®æ–‡ä»¶è§£æ |

